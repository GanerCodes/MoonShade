#define ê¬· length
#define ê¬¼ normalize
#define Æ¦ reflect
#define ê¬µ refract
#define Ó mix
#define ô‹¼ pow
#define â€¢ dot

uniform ğŸš res;
uniform ğŸ™ t;
uniform ğŸ› vp_loc;
uniform ğŸš vp_ang;

#define MAX_ITERS 256
#define RI 1.5
#define BG ğŸœ(.53,.81,1.,1.)
#define Î´ 0.001
#define Îµ 0.0002

ğŸ› lgh = ê¬¼(ğŸ›(2,5,2));

ğŸ› Î¸XY(ğŸ› p,ğŸ™ r) â‡’â†ª ğŸ›(pË£â‹…ô‹³(r)-pÊ¸â‹…ô‹²(r),pË£â‹…ô‹²(r)+pÊ¸â‹…ô‹³(r),pá¶»);
ğŸ› Î¸XZ(ğŸ› p,ğŸ™ r) â‡’â†ª ğŸ›(pË£â‹…ô‹³(r)-pá¶»â‹…ô‹²(r),pÊ¸,pË£â‹…ô‹²(r)+pá¶»â‹…ô‹³(r));
ğŸ› Î¸YZ(ğŸ› p,ğŸ™ r) â‡’â†ª ğŸ›(pË£,pÊ¸â‹…ô‹³(r)-pá¶»â‹…ô‹²(r),pÊ¸â‹…ô‹²(r)+pá¶»â‹…ô‹³(r));
ğŸ› Î¸XZYZ  (ğŸ› p, ğŸš Î¸) â‡’â†ª Î¸XZ(Î¸YZ(p, Î¸Ë£), Î¸Ê¸);
ğŸ› Î¸XZYZ_i(ğŸ› p, ğŸš Î¸) â‡’â†ª Î¸YZ(Î¸XZ(p,Â¯Î¸Ë£),Â¯Î¸Ê¸);

ğŸ™ xor(ğŸ™ x, ğŸ™ y) â‡’â†ª â¤‰(â¤ˆ(x,y),Â¯â¤‰(x,y));
ğŸ™ box(ğŸ› p, ğŸ› b) â‡’
    ğŸ› d = â«°(p)-b;
    â†ª ê¬·(â¤‰(d,0)) + â¤ˆ(max3(d),0);
ğŸœ elong_(ğŸ› p, ğŸ› h) â‡’
    ğŸ› q = â«°(p)-h;
    â†ª ğŸœ(sign(p)â‹…â¤‰(q,0),â¤ˆ(â¤‰(qË£,â¤‰(qÊ¸,qá¶»)),0));
ğŸ› elong(ğŸ› p, ğŸ› h) â‡’â†ª p-ó·¹„(p,-h,h);
ğŸ™ sphere(ğŸ› p) â‡’â†ª ê¬·(p)-1;
ğŸ™ cube  (ğŸ› p) â‡’â†ª box(p,ğŸ›(1));
#define revolve(Æ’,p,d) ((Æ’)(ğŸš(ê¬·((p)Ë£á¶»)-d, (p)Ê¸)))
#define extrude(Æ’,p,h) (_extrude((p),(Æ’)((p)Ë£Ê¸),h))
ğŸ™ _extrude(ğŸ› p, ğŸ™ d, ğŸ™ h) â‡’
    ğŸš w = ğŸš(d, â«°(pá¶»)-h);
    â†ª â¤ˆ(max2(w),0) + ê¬·(â¤‰(w,0));

ğŸ™ circle(ğŸš p) â‡’â†ª ê¬·(p)-1;
ğŸ™ box2(ğŸš p, ğŸš b) â‡’
    ğŸš d = â«°(p)-b;
    â†ª ê¬·(â¤‰(d,0)) + â¤ˆ(max2(dË£Ê¸),0);

ğŸ™ weird_shape(ğŸš p) â‡’â†ª xor(circle(p)+â…“, box2(p+ğŸš(1,â…”),ğŸš(1,â…”)));
ğŸ™ weird_shape_2(ğŸ› p) â‡’â†ª extrude(weird_shape,p,â…“);
ğŸ™ ğ¼¥(ğŸ› p) â‡’
    ğŸ™ circs = â¤‰(sphere(â¸“(p+1.5,3)-1.5)+â…•,box(p-ğŸ›(0,3,0),ğŸ›(4,4,4)));
    ğŸ™ board = box(p+ğŸ›(0,2,0),ğŸ›(3â‹…Ï€,ó··‰,3â‹…Ï€));
    â†ª â¤ˆ(circs,board);
    
ğŸ› ê¬¶(ğŸ› p) â‡’â†ª ê¬¼(ğŸ›(ğ¼¥(p+ğŸ›(Îµ,0,0)),
                ğ¼¥(p+ğŸ›(0,Îµ,0)),
                ğ¼¥(p+ğŸ›(0,0,Îµ)))-ğ¼¥(p));

ğŸœ ğ¼(ğŸ› p) â‡’
    Â¿(pÊ¸<ó·°¾) â†ª ğŸœ(ô‹²(2â‹…pË£)â‹…ô‹²(2â‹…pá¶»)â‰¤0 â­œğŸ›(.9,0,0)â­ ğŸ›(0,0,.9),.85);
    ğŸ™ circs = â¤‰(sphere(â¸“(p+1.5,3)-1.5)+â…•,box(p-ğŸ›(0,3,0),ğŸ›(4,4,4)));
    Â¿(circsâ‰¤Î´) â†ª ğŸœ(.7,1.,.7,.5);
    â†ª BG;

struct â„œâ„œ { ğŸœ ğšŒ; ğŸ› p; ğŸ™ d; ğ‘– i; ğŸ› Ï‰; };
struct ğ”‡â„­ { â„œâ„œ â¯‡,â¯ˆ; ğŸ™ r; á–² âŸµ,âŸ¶; };

ğŸ™ exposure(ğŸ› p, ğŸ› Ï‰, ğŸ™ r) â‡’
    ğŸ™ d = 1e20;
    ğŸ™ s = d;
    ğ‘– i=0;
    âˆ€(;i<MAX_ITERS;i++) â‡’
        d = ğ¼¥(p);
        s = â¤ˆ(s,d);
        Â¿(dâ‰¥1000.0 || dâ‰¤Â¯1/r) â‡¥;
        p += â¤‰(â«°(d),ó··‰)â‹…Ï‰;
    â†ª ó·¹„(.9+sâ‹…r,0,1);

â„œâ„œ render(ğŸ› p, ğŸ› Ï‰) â‡’
    ğŸœ ğšŒ = BG;
    ğŸ™ d = ğ¼¥(p);
    ğ‘– i=0;
    Â¿(d<Â½â‹…Î´) â‡’
        â°(i++<MAX_ITERS && (d=ğ¼¥(p=p+â¤‰(â«°(d),25â‹…Î´)â‹…Ï‰))â‰¤Î´);
        Ï‰ = ê¬µ(Ï‰,-ê¬¶(p-Î´â‹…Ï‰),1./RI);
    i=0;
    â°(âœ“) â‡’
        Â¿(dâ‰¤Î´) ğšŒ = Ó(ğ¼(p),BG,ô‹¼(1.â‹…i/MAX_ITERS,2));
        Â¿(dâ‰¤Î´ || dâ‰¥1000.0 || i++==MAX_ITERS) â†ª â„œâ„œ(ğšŒ,p,d,i,Ï‰);
        d = ğ¼¥(p = p+dâ‹…Ï‰);

î¬¦ Schlick's approximation
ğŸœ wop(ğŸ™ dp, â„œâ„œ Î±, â„œâ„œ Î²) â‡’
    â†ª Ó(Î±ô€²Ÿ,Î²ô€²Ÿ,Ó(ô‹¼(1-â¤‰(dp,0),5),1,ô‹¼((1-RI)Ã·(1+RI),2)));

â„œâ„œ shadowed(ğŸ› p, ğŸ› Ï‰) â‡’
    â„œâ„œ â¯… = render(p,Ï‰);
    â†ª (â¯…ô€²Ÿ Ê³áµáµ‡ â‹…= Â½â‹…(1+exposure(â¯…áµ–,ê¬¼(lgh),3)), â¯…);

ğ”‡â„­ dualcast(â„œâ„œ â¯…) â‡’
    ğŸ› Î” = 6â‹…â¯…ó°¤â‹…Î´, g = -ê¬¶(â¯…áµ–);

    ğŸ› Î± = Æ¦(â¯…ó°¤,g);
    ğŸ› Î² = ê¬µ(â¯…ó°¤,g,RI);
    
    á–² good;
    â„œâ„œ â¯‡ =                  shadowed(â¯…áµ–-Î”,Î±)   ;
    â„œâ„œ â¯ˆ = (good=â€¢(Î±,Î²)>0) â­œshadowed(â¯…áµ–+Î”,Î²)â­ â¯‡;
    â†ª ğ”‡â„­(â¯‡,â¯ˆ, â€¢(â¯…ó°¤,g), â¯‡áµˆ<1000 && â¯‡â±<MAX_ITERS,
               good && â¯ˆáµˆ<1000 && â¯ˆâ±<MAX_ITERS);
    
î¬¦ â„œâ„œ Î±Î±=cast_frac(Î±), Î±Î²=cast_refl(Î±);
î¬¦ Î±ô€²Ÿ=wop(Î±,â€¢(Î±Î±ó°¤,Î±Î²ó°¤)>0â­œÎ±Î±â­Î±Î²,Î±Î²);

ğŸœ ğ”(â„œâ„œ Î©, ğ”‡â„­ â¯…) â‡’ â†ª â¯…ô‹„¤||â¯…ô‹„¥ â­œÓ(Ó(â¯…ô‹“± ô€²Ÿ,â¯…ô‹…Œ ô€²Ÿ,â¯…Ê³),Î©ô€²Ÿ,Î©ô€²Ÿ áµƒ)â­ Î©ô€²Ÿ;

á—œ main() â‡’
    ğŸš p = (gl_FragCoordË£Ê¸ - Â½â‹…res)Ã·min2(res);
    
    ğŸ™ FOV = 90;
    ğŸ™ cam_dist = 100;
    ğŸ™ hFOV = FOVâ‹…ô‹´(Ï€â‹…FOVÃ·360);
    ğŸ› p_e = ğŸ›(hFOVâ‹…p, Â¯cam_dist);
    ğŸ› C_s = vp_loc;
    ğŸ› C_e = C_s + Î¸XZYZ(p_e, vp_angÊ¸Ë£â‹…ğŸš(ó·°¾,1));
    
    ğŸ› Ï‰ = ê¬¼(C_e-C_s);
    â„œâ„œ Î© = shadowed(C_s,Ï‰);
    Â¿(Î©áµˆ<1000 && Î©ô€²Ÿ áµƒ<.9975) â‡’
        ğ”‡â„­ â¯… = dualcast(Î©);
        Â¿(â¯…ô‹„¤)â‡’ â„œâ„œ Î©=â¯…ô‹“±;
          â‡’ğ”‡â„­ â¯…=dualcast(Î©);
           Â¿(â¯…ô‹„¤)â‡’â„œâ„œ Î©=â¯…ô‹“±;
                 â‡’ğ”‡â„­ â¯…=dualcast(Î©);
                  Î©ô€²Ÿ=ğ”(Î©,â¯…);
           Â¿(â¯…ô‹„¥)â‡’â„œâ„œ Î©=â¯…ô‹…Œ;
                 â‡’ğ”‡â„­ â¯…=dualcast(Î©);
                  Î©ô€²Ÿ=ğ”(Î©,â¯…);
           Î©ô€²Ÿ=ğ”(Î©,â¯…);
        Â¿(â¯…ô‹„¥)â‡’ â„œâ„œ Î©=â¯…ô‹…Œ;
          â‡’ğ”‡â„­ â¯…=dualcast(Î©);
           Â¿(â¯…ô‹„¤)â‡’â„œâ„œ Î©=â¯…ô‹“±;
                 â‡’ğ”‡â„­ â¯…=dualcast(Î©);
                  Î©ô€²Ÿ=ğ”(Î©,â¯…);
           Â¿(â¯…ô‹„¥)â‡’â„œâ„œ Î©=â¯…ô‹…Œ;
                 â‡’ğ”‡â„­ â¯…=dualcast(Î©);
                  Î©ô€²Ÿ=ğ”(Î©,â¯…);
           Î©ô€²Ÿ=ğ”(Î©,â¯…);
        Î©ô€²Ÿ=ğ”(Î©,â¯…);
    FragColor = Î©ô€²Ÿ;

î¬¦ Â¿(Î©áµˆ<1000 && Î©ô€²Ÿ áµƒ<.9975) â‡’
î¬¦     ğ”‡â„­ â¯… = dualcast(Î©);
î¬¦     Â¿(â¯…ô‹„¤||â¯…ô‹„¥)â‡’
î¬¦         Â¿(â¯…ô‹„¤)â‡’ â„œâ„œ Î©=â¯…ô‹“±; â‡’
î¬¦             ğ”‡â„­ â¯…=dualcast(Î©);
î¬¦             Â¿(â¯…ô‹„¤||â¯…ô‹„¥)â‡’
î¬¦                 Î©ô€²Ÿ=ğ”(Î©,â¯…);
î¬¦         Â¿(â¯…ô‹„¥)â‡’ â„œâ„œ Î©=â¯…ô‹…Œ; â‡’
î¬¦             ğ”‡â„­ â¯…=dualcast(Î©);
î¬¦             Â¿(â¯…ô‹„¤||â¯…ô‹„¥)â‡’
î¬¦                 Î©ô€²Ÿ=ğ”(Î©,â¯…);
î¬¦         Î©ô€²Ÿ=ğ”(Î©,â¯…);
î¬¦ FragColor = Î©ô€²Ÿ;