uniform ğŸš res;
î¬¦ uniform ğŸ™ t;
î¬¦ uniform ğŸ› vp_loc;
î¬¦ uniform ğŸš vp_ang;
#define t 2.5
#define vp_loc ğŸ›(ó·°¾ó·°¿,8,ó·°¾ó·°¿)
#define vp_ang ğŸš(Â¾â‹…Ï€,ó·¶²)

#define MAX_ITERS 256
#define RI 1.5
#define BG ğŸœ(.53,.81,1.,1.)
#define Î´ 0.001
#define Îµ 0.0002

ğŸ› lgh = ê¬¼(ğŸ›(2,5,2));

ğŸ™ xor(ğŸ™ x, ğŸ™ y) â‡’â†ª â¤‰(â¤ˆ(x,y),Â¯â¤‰(x,y));
ğŸ™ box(ğŸ› p, ğŸ› b) â‡’
    ğŸ› d = â«°(p)-b;
    â†ª ê¬·(â¤‰(d,0)) + â¤ˆ(max3(d),0);
ğŸœ elong_(ğŸ› p, ğŸ› h) â‡’
    ğŸ› q = â«°(p)-h;
    â†ª ğŸœ(sign(p)â‹…â¤‰(q,0),â¤ˆ(â¤‰(qË£,â¤‰(qÊ¸,qá¶»)),0));
ğŸ› elong(ğŸ› p, ğŸ› h) â‡’â†ª p-ó·¹„(p,-h,h);
ğŸ™ sphere(ğŸ› p) â‡’â†ª ê¬·(p)-1;
ğŸ™ cube  (ğŸ› p) â‡’â†ª box(p,ğŸ›(1));
#define revolve(Æ’,p,d) ((Æ’)(ğŸš(ê¬·((p)Ë£á¶»)-d, (p)Ê¸)))
#define extrude(Æ’,p,h) (_extrude((p),(Æ’)((p)Ë£Ê¸),h))
ğŸ™ _extrude(ğŸ› p, ğŸ™ d, ğŸ™ h) â‡’
    ğŸš w = ğŸš(d, â«°(pá¶»)-h);
    â†ª â¤ˆ(max2(w),0) + ê¬·(â¤‰(w,0));

ğŸ™ circle(ğŸš p) â‡’â†ª ê¬·(p)-1;
ğŸ™ box2(ğŸš p, ğŸš b) â‡’ ğŸš d = â«°(p)-b;
                   â†ª ê¬·(â¤‰(d,0)) + â¤ˆ(max2(dË£Ê¸),0);
ğŸ™ weird_shape(ğŸš p) â‡’â†ª xor(circle(p)+â…“, box2(p+ğŸš(1,â…”),ğŸš(1,â…”)));
ğŸ™ weird_shape_2(ğŸ› p) â‡’â†ª extrude(weird_shape,p,â…“);

ğŸ™ shiney(ğŸ› p) â‡’â†ª â¤ˆ(
    â¤‰(â¤‰(sphere(â¸“(p+Â½â‹…4,4)-Â½â‹…4)+â…•,box(p-ğŸ›(0,4,0),ğŸ›(5))),-box(p-ğŸ›(0,4,0),ğŸ›(1))),
    â¤ˆ(box(p+ğŸ›(6â‹…ô‹³(t),ó·±€,6â‹…ô‹²(t)),ğŸ›(1)),
    extrude(circle,Î¸XZYZ((p+ğŸ›(0,ó·±€,0))á¶»Ë£Ê¸,ğŸš(t,t)),1)-3â‹…ó··‰)
    );

ğŸ™ ğ¼¥(ğŸ› p)â‡’ ğŸ™ circs = shiney(p);
          ğŸ™ board = box(p+ğŸ›(0,2,0),ğŸ›(3â‹…Ï€,ó··‰,3â‹…Ï€));
          â†ª â¤ˆ(circs,board);

ğŸ› ê¬¶(ğŸ› p) â‡’â†ª ê¬¼(ğŸ›(ğ¼¥(p+ğŸ›(Îµ,0,0)),ğ¼¥(p+ğŸ›(0,Îµ,0)),ğ¼¥(p+ğŸ›(0,0,Îµ)))-ğ¼¥(p));

ğŸœ ğ¼(ğŸ› p) â‡’
    Â¿(pÊ¸<ó·°¾) â†ª ğŸœ(ô‹²(2â‹…pË£)â‹…ô‹²(2â‹…pá¶»)â‰¤0 â­œğŸ›(.9,0,0)â­ ğŸ›(0,0,.9),.85);
    ğŸ™ circs = shiney(p);
    Â¿(circsâ‰¤Î´) â†ª ğŸœ(.3,.6,.3,.3);
    â†ª BG;

struct â„œâ„œ { ğŸœ ğšŒ; ğŸ› p; ğŸ™ d; ğ‘– i; ğŸ› Ï‰; };
struct ğ”‡â„­ { â„œâ„œ â¯…,â¯‡,â¯ˆ,â¯†; ğŸ™ r; };

ğŸ™ exposure(ğŸ› p, ğŸ› Ï‰, ğŸ™ r) â‡’
    ğŸ™ s = 1e20;
    âˆ€(ğ‘– i=0; i<MAX_ITERS; i++) â‡’
        ğŸ™ d = ğ¼¥(p);
        s = â¤ˆ(s,d);
        Â¿(dâ‰¥1000.0 || dâ‰¤Â¯1Ã·r) â‡¥;
        p += â¤‰(â«°(d),ó··‰)â‹…Ï‰;
    â†ª ó·¹„(.9+sâ‹…r,0,1);

â„œâ„œ render(ğŸ› p, ğŸ› Ï‰) â‡’
    ğŸœ ğšŒ = BG;
    ğŸ™ d = ğ¼¥(p);
    ğ‘– i=0;
    Â¿(d<Â½â‹…Î´) â‡’
        â°(i++<MAX_ITERS && (d=ğ¼¥(p=p+â¤‰(â«°(d),20â‹…Î´)â‹…Ï‰))â‰¤Î´);
        Ï‰ = ê¬µ(Ï‰,-ê¬¶(p-10â‹…Î´â‹…Ï‰),1./RI);
        i=0;
    â°(âœ“) â‡’
        Â¿(dâ‰¤Î´) ğšŒ = Ó(ğ¼(p),BG,ô‹¼(1.â‹…i/MAX_ITERS,2));
        Â¿(dâ‰¤Î´ || dâ‰¥1000.0 || i++â‰¡MAX_ITERS) â†ª â„œâ„œ(ğšŒ,p,d,i,Ï‰);
        d = ğ¼¥(p = p+dâ‹…Ï‰);

â„œâ„œ shadowed(ğŸ› p, ğŸ› Ï‰) â‡’
    â„œâ„œ â¯… = render(p,Ï‰);
    â†ª (â¯…ô€²Ÿ Ê³áµáµ‡ â‹…= Â½â‹…(1+exposure(â¯…áµ–,ê¬¼(lgh),3)), â¯…);

ğ”‡â„­ mcasts(in â„œâ„œ â¯…) â‡’
    ğŸ› Î”=2â‹…â¯…ó°¤â‹…Î´, g=-ê¬¶(â¯…áµ–);
    
    ğŸ› Î± = Æ¦(â¯…ó°¤,g);
    ğŸ› Î² = ê¬µ(â¯…ó°¤,g,RI);
    ğŸ› Î³ =   â¯…ó°¤;
    
    î¬¦ Schlick's approximation
    ğŸ™ dp = â¤‰(â€¢(â¯…ó°¤,g),0);
    ğŸ™ w = Ó(ô‹¼(1-dp,5),1.,ô‹¼((1-RI)Ã·(1+RI),2));
    
    â„œâ„œ â¯‡ = (      shadowed(â¯…áµ–-Î”,Î±)   );
    â„œâ„œ â¯ˆ = (dpâ‰¥0 â­œshadowed(â¯…áµ–+Î”,Î²)â­ â¯‡);
    â„œâ„œ â¯† = (      shadowed(â¯…áµ–+Î”,Î³)   );
    
    Â¿(        â¯‡áµˆâ‰¥1000 || â¯‡â±â‰¥MAX_ITERS) â¯‡â±=ó·°¾;
    Â¿(dp<0 || â¯ˆáµˆâ‰¥1000 || â¯ˆâ±â‰¥MAX_ITERS) â¯ˆâ±=ó·°¾;
    Â¿(        â¯†áµˆâ‰¥1000 || â¯†â±â‰¥MAX_ITERS) â¯†â±=ó·°¾;
    
    â†ª ğ”‡â„­(â¯…,â¯‡,â¯ˆ,â¯†,w);

ğŸœ ğ”(ğ”‡â„­ â¯…) â‡’â†ª Ó(Ó(â¯…ô‹“± ô€²Ÿ,â¯…ô‹…Œ ô€²Ÿ,ó·¹„(â¯…Ê³,0,1)),
               Ó(â¯…ô‹“­ ô€²Ÿ,â¯…ô‹“¯ ô€²Ÿ,â¯…ô‹“¯ áµˆ<1000 â­œÂ½â­ 0),
               â¯…ô‹“­ ô€²Ÿ áµƒ);

á—œ main() â‡’
    ğŸš p = (gl_FragCoordË£Ê¸ - Â½â‹…res)Ã·min2(res);
    
    ğŸ™ FOV = 90;
    ğŸ™ cam_dist = 100;
    ğŸ™ hFOV = FOVâ‹…ô‹´(Ï€â‹…FOVÃ·360);
    ğŸ› p_e = ğŸ›(hFOVâ‹…p, Â¯cam_dist);
    ğŸ› C_s = vp_loc;
    ğŸ› C_e = C_s + Î¸XZYZ(p_e, vp_angÊ¸Ë£â‹…ğŸš(ó·°¾,1));
    
    ğŸ› Ï‰ = ê¬¼(C_e-C_s);
    â„œâ„œ Î© = shadowed(C_s,Ï‰);
    Â¿(Î©áµˆ<1000 && Î©ô€²Ÿ áµƒ<.9975) â‡’
        ğ”‡â„­ â¯… = mcasts(Î©);
        Â¿(â¯…ô‹“± â±â‰ ó·°¾)â‡’
            â„œâ„œ Î©=â¯…ô‹“±;
            â‡’   ğ”‡â„­ â¯…=mcasts(Î©);
                Î©ô€²Ÿ=ğ”(â¯…);
            â¯…ô‹“±=Î©;
        Â¿(â¯…ô‹…Œ â±â‰ ó·°¾)â‡’
            â„œâ„œ Î©=â¯…ô‹…Œ;
            â‡’   ğ”‡â„­ â¯…=mcasts(Î©);
                Î©ô€²Ÿ=ğ”(â¯…);
            â¯…ô‹…Œ=Î©;
        Â¿(â¯…ô‹“¯ â±â‰ ó·°¾)â‡’
            â„œâ„œ Î©=â¯…ô‹“¯;
            â‡’   ğ”‡â„­ â¯…=mcasts(Î©);
                Î©ô€²Ÿ=ğ”(â¯…);
            â¯…ô‹“¯=Î©;
        Î©ô€²Ÿ=ğ”(â¯…);
    FragColor = Î©ô€²Ÿ;