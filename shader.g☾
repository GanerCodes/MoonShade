uniform ğŸš res;
uniform ğŸ™ t;
uniform ğŸ› vp_loc;
uniform ğŸš vp_ang;

#define MAX_ITERS 128
#define Îµ 0.0001

ğŸ› rot_XY(ğŸ› p,ğŸ™ r) â‡’â†ª ğŸ›(pË£â‹…ô‹³(r)-pÊ¸â‹…ô‹²(r),pË£â‹…ô‹²(r)+pÊ¸â‹…ô‹³(r),pá¶»);
ğŸ› rot_XZ(ğŸ› p,ğŸ™ r) â‡’â†ª ğŸ›(pË£â‹…ô‹³(r)-pá¶»â‹…ô‹²(r),pÊ¸,pË£â‹…ô‹²(r)+pá¶»â‹…ô‹³(r));
ğŸ› rot_YZ(ğŸ› p,ğŸ™ r) â‡’â†ª ğŸ›(pË£,pÊ¸â‹…ô‹³(r)-pá¶»â‹…ô‹²(r),pÊ¸â‹…ô‹²(r)+pá¶»â‹…ô‹³(r));
ğŸ› rot_XZ_YZ(ğŸ› p, ğŸ™ r1, ğŸ™ r2) â‡’â†ª rot_XZ(rot_YZ(p, r1), r2);

ğŸ› star(ğŸš p, ğŸ™ t, ğŸ™ antiblur) â‡’
    p â‹…= 10;
    p = ğŸš(5.0â‹…atan(pÊ¸, pË£),
           ((length(p)-10)Ã·5 + 1)â‹…2.5);
    ğŸ™ v = pÊ¸ - ô‹¼(1.1â‹…(â«°(ô‹³(pË£Ã·2))-â«°(ô‹²(pË£Ã·2))));
    â†ª hsv2rgb(ğŸ›(â¸“(2.2â‹…t, 1), 0.6, ó·¹„(Â¯vâ‹…antiblur, 0, 1)));

ğŸœ starz(ğŸš p, ğŸ™ t, ğŸš off, ğŸ™ antiblur) â‡’
    p += ô‹²(ğŸš(401.29, -4.3)â‹…off);
    ğŸš loc = â¬“(pÃ·2 + Â½) + off;
    pË£ += ó·°¿â‹…â«°(ô‹³(locÊ¸))â‹…t;
    loc = â¬“(pÃ·2 + Â½) + off;
    p = â¸“(p+2, 4)-2;
    ğŸœ c = ğŸœ(0);
    ğŸ™ sd = â¸“(2â‹…ô‹³(24.0â‹…locË£)+5.5â‹…ô‹²(31.0â‹…locÊ¸), 1);
    p â‹…= 4 + ô‹²(49.0â‹…sd);
    p += ğŸš(ô‹³(sdâ‹…52.5), ô‹²(sd+200));
    Â¿(sd â‰¤ Â½) â‡’
        ğŸ™ d = length(p),
          a = atan(pÊ¸,pË£)+Â½â‹…tâ‹…ô‹²(Ï„â‹…sd);
        p = dâ‹…ğŸš(ô‹³(a),ô‹²(a));
        ğŸ™ tt = tÃ·(5+2â‹…sd) + 2â‹…sd;
        ğŸ› c1 = star(pÃ·(1 + 0.005â‹…antiblur), tt, sd+antiblur);
        ğŸ› c2 = star((1.1 + â…’â‹…sd)â‹…p, tt, sd+antiblur);
        c = ó·¹„(ğŸœ(c1 - c2, length(c1)â‰¥0.99 â­œ(length(c2)â‰¥0.99 â­œâ…˜â­ 1)â­ 0), 0, 1);
    Â¡ â‡’
        ğŸ™ tt = ó·¹„(1-10â‹…length(p), 0, 1);
        ğŸ› cc = hsv2rgb(ğŸ›(â¤‰(sd, â…•)â‹…t + sd, 0.03â‹…sd + â…’, tt));
        c = ğŸœ(cc, â…’â‹…length(tt));
    â†ª c;

ğŸ™ box(ğŸ› p, ğŸ› b) â‡’
    ğŸ› d = â«°(p)-b;
    â†ª length(â¤‰(d,0)) + â¤ˆ(max3(d),0);
ğŸ™ xor(ğŸ™ x, ğŸ™ y) â‡’â†ª â¤‰(â¤ˆ(x,y),Â¯â¤‰(x,y));

ğŸ™ ğ¼¥(ğŸ› p) â‡’
    p = ğŸ›(length(pË£á¶»)-1.0, pÊ¸, 0.0);
    â†ª box(p,ğŸ›(1)); î¬¦ +â…’â‹…ô‹³(t)
ğŸ› ê¬¶(ğŸ› p) â‡’â†ª normalize(ğŸ›(ğ¼¥(p+ğŸ›(Îµ,0,0)),
                        ğ¼¥(p+ğŸ›(0,Îµ,0)),
                        ğ¼¥(p+ğŸ›(0,0,Îµ)))-ğ¼¥(p));
ğŸœ ğ¼(ğŸ› p) â‡’â†ª ğŸœ(1,1,1,1);

ğŸœ render(ğŸš ğš™) â‡’
    ğŸ™ FOV = 125;
    ğŸ™ cam_dist = 100;
    ğŸ™ hFOV = FOVâ‹…ô‹´(Ï€â‹…FOVÃ·360);
    ğŸ› p_e = ğŸ›(hFOVâ‹…ğš™, Â¯cam_dist);

    ğŸ› C_s = vp_loc;
    ğŸ› C_e = C_s + rot_XZ_YZ(p_e, Â¯vp_angÊ¸, vp_angË£);
    ğŸ› dir = normalize(C_e - C_s);

    ğŸ› p = C_s;
    á–² invert = ğ¼¥(p)<0;

    ğŸœ ğšŒ = ğŸœ(0);

    âˆ€(ğ‘– i=0; i<MAX_ITERS; i++) â‡’
        ğŸ™ d = ğ¼¥(p);
        Â¿(dâ‰¤0.001) â‡’
            ğŸœ c = ğ¼(p);
            cÊ³áµáµ‡ = (1-i/MAX_ITERS)â‹…cÊ³áµáµ‡â‹…Â½â‹…â¤‰(0, dot(ê¬¶(p), -normalize(dir)));
            ğšŒ = ğŸœ(ğšŒÊ³áµáµ‡â‹…ğšŒáµƒ + cÊ³áµáµ‡â‹…(1-ğšŒáµƒ)â‹…cáµƒ, ğšŒáµƒ+(1-ğšŒáµƒ)â‹…cáµƒ);
            Â¿(ğšŒáµƒ â‰¥ 0.99) â‡¥;
        Â¿(dâ‰¥1000.0) â‡¥;
        p += dâ‹…dir;
    â†ª ğšŒÃ·ó·¹„((length(p-C_s)-1)â‹…â…•, 1, 1.1);

á—œ main() â‡’
    ğŸœ ğšŒ = render((gl_FragCoordË£Ê¸ - Â½â‹…res) Ã· min2(res));
    FragColor = ğŸœ(ğšŒÊ³áµáµ‡â‹…ğšŒáµƒ, 1);
    
    î¬¦ ğŸš p = gl_FragCoord.xy Ã· res;
    î¬¦ ğŸš p = gl_FragCoord.xy Ã· min2(res);
    î¬¦ ğŸœ c = ğŸœ(0);
    î¬¦ p = (p-Â½)â‹…5;
    î¬¦ î¬¦ ğŸ™ v = â¤ˆ(box(p,ğŸš(1)), length(p-ğŸš(Â¾,Â¾))-1);
    î¬¦ î¬¦ ğŸ™ v = xor(box(p,ğŸš(1)), length(p-ğŸš(Â¾,Â¾))-1);
    î¬¦ ğŸ™ v = â¤‰(box(p,ğŸš(1)), length(p-ğŸš(Â¾,Â¾))-1);
    î¬¦ ğŸ™ H = â…’;
    î¬¦ ğŸ™ j = â¸“(v,H);
    î¬¦ cáµ‡=.8â‹…(jâ‰¤Â½â‹…H â­œsmoo(â«°(2â‹…(2â‹…j/H-Â½)),8)â­ 1);
    î¬¦ cÊ³=vâ‰¤0 â­œcáµ‡â­ 0;
    î¬¦ Â¿(â«°(v)â‰¤Â¾â‹…â…’â‹…H) cáµ=1;
    î¬¦ cÊ·=1;
    î¬¦ FragColor = ğŸœ(cË£Ê¸á¶»â‹…cÊ·, 1);
    
    î¬¦ p -= ğŸš(Â½);
    î¬¦ p â‹…= 8;
    î¬¦ p += ğŸš(-t,5);
    î¬¦ 
    î¬¦ ğŸœ c = ğŸœ(0);
    î¬¦ 
    î¬¦ ğŸ™ c1 = 265Ã·360; // rgb2hsv(ğŸ›(0,0,1));
    î¬¦ ğŸ™ c2 = 290Ã·360; // rgb2hsv(ğŸ›(0.6,â…•,1));
    î¬¦ ğŸ™ D = mix(c1, c2, ó·¹„(
    î¬¦             ô‹²(pÊ¸)â‹…ô‹³(pË£)+ô‹²(pÊ¸-Â½â‹…ô‹³(â…•â‹…t))-â…•â‹…ô‹³(t)
    î¬¦             +2â‹…ô‹³(pË£+ô‹²(pÊ¸)-ô‹³(t-pË£)â‹…pÊ¸)â‹…ô‹²(pÊ¸â‹…â…•+ô‹³(0.05â‹…pÊ¸+â¸“(pË£,Ï„)))
    î¬¦             +ô‹³(pÊ¸-â¸“(pË£,Ï„)), 0, 1));
    î¬¦ ğŸ› d = hsv2rgb(ğŸ›(D, 1.0, 0.9)) â‹… 1.0;
    î¬¦ c += ğŸœ(dâ‹…0.025, 0.025);
    î¬¦ 
    î¬¦ âˆ€(ğ‘– i = 0; i < 200; i+=ó·¹„(iÃ·5,1,4)) {
    î¬¦     ğ‘– o = i/3;
    î¬¦     ğŸ™ s = 0.001 + oÃ·22.5;
    î¬¦     c += (1-c)â‹…(1-cÊ·)â‹…starz(sâ‹…p, t, ğŸš(3123â‹…i, 25â‹…i + 1221 - 35â‹…o), 2+o); }
    î¬¦ c += (1-c)â‹…ğŸœ(â…’â‹…d,Â½);
    î¬¦ FragColor = ğŸœ(cË£Ê¸á¶»â‹…cÊ·, 1.0);